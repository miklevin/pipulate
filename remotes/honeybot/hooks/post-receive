#!/bin/sh
set -e
# The "Sovereign Build" Hook (Hybrid Late-Stage Edition)

GIT_DIR="/home/mike/git/mikelev.in.git"
WORK_TREE="/home/mike/www/mikelev.in"

echo "ðŸŽ¯ [Hook] Received Push. Deploying..."

# 1. Force Checkout to the Web Root
git --work-tree=$WORK_TREE --git-dir=$GIT_DIR checkout -f main

# 2. Enter the Arena
cd $WORK_TREE
echo "ðŸ”¨ [Hook] Starting Hybrid Build..."

# 3. The Build Command
# We use 'nix develop' to get Ruby/GCC/Libs, but we manually
# setup the gem environment because --command skips shellHook.
nix develop --command bash -c "
  # ... env setup ...
  
  # --- THE BUILD ---
  echo 'ðŸ—ï¸  Jekyll Build...'
  bundle exec jekyll build --future
  
  # --- PUBLISH SOURCE MARKDOWN (NEW) ---
  echo 'ðŸ“„ Publishing Source Markdown...'
  # Create the destination directory
  mkdir -p _site/source/
  
  # Copy posts, preserving structure if needed, or just flat list
  # We copy the entire _posts folder to _site/source/
  cp -r _posts/* _site/source/
  
  # Optional: Copy pages too if they are markdown
  # cp *.md _site/source/ 2>/dev/null || true
"

# 4. Permissions Fix (Crucial for Nginx)
echo "ðŸ”’ [Hook] Fixing Permissions..."
chmod -R 755 $WORK_TREE/_site

echo "âœ… [Hook] Deployment Complete. Site is Live."
