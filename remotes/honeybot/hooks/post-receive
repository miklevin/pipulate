#!/bin/sh
# The "Sovereign Build" Hook (Hybrid Late-Stage Edition)

GIT_DIR="/home/mike/git/mikelev.in.git"
WORK_TREE="/home/mike/www/mikelev.in"

echo "ğŸ¯ [Hook] Received Push. Deploying..."

# 1. Force Checkout to the Web Root
git --work-tree=$WORK_TREE --git-dir=$GIT_DIR checkout -f main

# 2. Enter the Arena
cd $WORK_TREE
echo "ğŸ”¨ [Hook] Starting Hybrid Build..."

# 3. The Build Command
# We use 'nix develop' to get Ruby/GCC/Libs, but we manually
# setup the gem environment because --command skips shellHook.
nix develop --command bash -c "
  # --- MANUAL ENV SETUP (Mimics shellHook) ---
  export GEM_HOME=\$PWD/.gem
  export PATH=\$GEM_HOME/bin:\$PATH
  export BUNDLE_FORCE_RUBY_PLATFORM=1
  
  # --- LATE-STAGE DEPENDENCY MANAGEMENT ---
  echo 'ğŸ’ Checking Gems...'
  # Ensure bundler is present (Nix provides Ruby, but maybe not bundler binary in path)
  gem install bundler --no-document --silent
  
  # Install site dependencies into local .gem/
  bundle install --quiet
  
  # --- THE BUILD ---
  echo 'ğŸ—ï¸  Jekyll Build...'
  bundle exec jekyll build --future
"

# 4. Permissions Fix (Crucial for Nginx)
echo "ğŸ”’ [Hook] Fixing Permissions..."
chmod -R 755 $WORK_TREE/_site

echo "âœ… [Hook] Deployment Complete. Site is Live."
